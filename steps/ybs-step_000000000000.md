# Step 0: Build Configuration

**Version**: 0.1.0

## Overview

This step collects all configuration decisions needed for building a YX protocol implementation. The configuration determines which language-specific build steps will be executed and sets up the build environment.

## Step Objectives

1. Determine which language implementation to build (Python, Swift, or Both)
2. Set build directory name
3. Create BUILD_CONFIG.json with all configuration values
4. Direct to appropriate language-specific step sequence

## Prerequisites

- YX system directory structure exists
- Specifications have been reviewed:
  - `../specs/technical/yx-protocol-spec.md`
  - `../specs/testing/testing-strategy.md`
  - `../specs/architecture/implementation-languages.md`

## Configurable Values

- `{{CONFIG:language|choice[Python,Swift,Both]|Implementation language to build|Python}}`
- `{{CONFIG:build_name|string|Build directory name|python-impl}}`
- `{{CONFIG:enable_tests|boolean|Generate unit tests for each step|true}}`
- `{{CONFIG:python_version|string|Python version requirement|3.11}}`
- `{{CONFIG:swift_version|string|Swift version requirement|5.9}}`

## Traceability

**Implements**:
- specs/architecture/implementation-languages.md (Language Selection)
- YBS methodology (Step 0: Configuration Collection)

**References**:
- specs/technical/yx-protocol-spec.md (Protocol requirements)
- specs/testing/testing-strategy.md (Testing requirements)

## Instructions

### 1. Check for Existing Configuration

**If BUILD_CONFIG.json exists in the current build directory:**
- Read and display the existing configuration
- Skip all questions
- Proceed to next step based on language selection
- **STOP HERE** - Do not ask any questions

**If BUILD_CONFIG.json does NOT exist:**
- Continue to step 2

### 2. Collect Configuration Values

Ask the user for each configurable value listed above:

**Question 1: Implementation Language**
```
Which language implementation would you like to build?
  1. Python (Reference implementation, generates canonical artifacts)
  2. Swift (High-performance, validates against canonical artifacts)
  3. Both (Python first, then Swift)

Selection:
```

**Question 2: Build Directory Name**
```
Enter the build directory name (e.g., "python-impl", "swift-impl"):
Default: [based on language selection]

Build name:
```

**Question 3: Enable Tests**
```
Generate unit tests for each step? (true/false)
Default: true

Enable tests:
```

**Question 4: Python Version** (if Python selected)
```
Python version requirement (e.g., "3.11", "3.12"):
Default: 3.11

Python version:
```

**Question 5: Swift Version** (if Swift selected)
```
Swift version requirement (e.g., "5.9", "5.10"):
Default: 5.9

Swift version:
```

### 3. Create Build Directory

Create the build directory structure:

```bash
mkdir -p builds/{{CONFIG:build_name}}
mkdir -p builds/{{CONFIG:build_name}}/docs
mkdir -p builds/{{CONFIG:build_name}}/docs/build-history
```

If language is "Python":
```bash
mkdir -p builds/{{CONFIG:build_name}}/src
mkdir -p builds/{{CONFIG:build_name}}/tests
```

If language is "Swift":
```bash
mkdir -p builds/{{CONFIG:build_name}}/Sources
mkdir -p builds/{{CONFIG:build_name}}/Tests
```

### 4. Create BUILD_CONFIG.json

Create `builds/{{CONFIG:build_name}}/BUILD_CONFIG.json` with the following structure:

```json
{
  "version": "0.1.0",
  "generated": "<ISO 8601 timestamp>",
  "system_name": "yx",
  "values": {
    "language": "<selected language>",
    "build_name": "<build directory name>",
    "enable_tests": <true/false>,
    "python_version": "<version if Python>",
    "swift_version": "<version if Swift>"
  },
  "metadata": {
    "step_sequence": "<python|swift|both>",
    "config_sources": ["ybs-step_000000000000"]
  }
}
```

### 5. Create BUILD_STATUS.md

Create `builds/{{CONFIG:build_name}}/BUILD_STATUS.md`:

```markdown
# Build Status: {{CONFIG:build_name}}

**Language**: {{CONFIG:language}}
**Started**: <timestamp>
**Last Updated**: <timestamp>

## Progress

- [x] Step 0: Build Configuration
- [ ] Step 1: Project Setup
- [ ] Step 2: GUID Factory
- [ ] Step 3: Packet Structure
- [ ] Step 4: HMAC Computation
- [ ] Step 5: Packet Builder
- [ ] Step 6: Packet Parser
- [ ] Step 7: Packet Validation
- [ ] Step 8: UDP Transport

## Metrics

- **Steps Completed**: 1 / 9
- **Tests Passing**: 0 / 0
- **Code Coverage**: 0%
- **Traceability**: 0%

## Current Step

- **Step**: 0
- **Status**: Complete
- **Next**: Step 1 (Project Setup)

## Issues

None yet.
```

### 6. Create SESSION.md

Create `builds/{{CONFIG:build_name}}/SESSION.md`:

```markdown
# Build Session: {{CONFIG:build_name}}

**System**: yx
**Build Name**: {{CONFIG:build_name}}
**Language**: {{CONFIG:language}}
**Started**: <timestamp>
**Last Updated**: <timestamp>

## Current Status

- Step 0 (Build Configuration) completed
- Ready to proceed to Step 1 (Project Setup)

## Configuration

- Language: {{CONFIG:language}}
- Build directory: builds/{{CONFIG:build_name}}
- Tests enabled: {{CONFIG:enable_tests}}

## Next Actions

1. Execute Step 1 (Project Setup) from steps/{{CONFIG:language|lowercase}}/
2. Follow language-specific step sequence
3. Update BUILD_STATUS.md after each step
4. Update this SESSION.md file after each significant action

## Notes

- Configuration collected and saved to BUILD_CONFIG.json
- Build directory structure created
- Ready for autonomous step execution
```

### 7. Display Next Steps

Output the following to the user:

```
✓ Configuration complete!

Build Configuration:
  - Language: {{CONFIG:language}}
  - Build Name: {{CONFIG:build_name}}
  - Build Directory: builds/{{CONFIG:build_name}}
  - Tests Enabled: {{CONFIG:enable_tests}}

Next Steps:
  - Execute Step 1 (Project Setup) from steps/{{CONFIG:language|lowercase}}/
  - Build steps will execute autonomously
  - Progress tracked in builds/{{CONFIG:build_name}}/BUILD_STATUS.md

To resume this build later, this directory contains:
  - BUILD_CONFIG.json (configuration)
  - BUILD_STATUS.md (progress tracking)
  - SESSION.md (crash recovery)

Ready to proceed to Step 1.
```

### 8. Determine Next Step Sequence

Based on language selection:

**If Python:**
- Next step: `steps/python/ybs-step_<guid-step-1>.md` (Project Setup)

**If Swift:**
- Next step: `steps/swift/ybs-step_<guid-step-1>.md` (Project Setup)

**If Both:**
- Build Python first (generates canonical artifacts)
- Then build Swift (validates against canonical artifacts)
- Next step: `steps/python/ybs-step_<guid-step-1>.md`

## Verification

**This step is complete when:**

- [ ] BUILD_CONFIG.json exists at `builds/{{CONFIG:build_name}}/BUILD_CONFIG.json`
- [ ] BUILD_CONFIG.json is valid JSON
- [ ] BUILD_CONFIG.json contains all required fields
- [ ] BUILD_STATUS.md exists at `builds/{{CONFIG:build_name}}/BUILD_STATUS.md`
- [ ] SESSION.md exists at `builds/{{CONFIG:build_name}}/SESSION.md`
- [ ] Build directory structure created (`src/` or `Sources/`, `tests/` or `Tests/`, `docs/`)
- [ ] Configuration values are valid (language is Python/Swift/Both, versions are valid)
- [ ] Next step sequence is determined

**Verification Commands:**

```bash
# Verify BUILD_CONFIG.json exists and is valid JSON
test -f builds/{{CONFIG:build_name}}/BUILD_CONFIG.json && \
  python3 -m json.tool builds/{{CONFIG:build_name}}/BUILD_CONFIG.json > /dev/null && \
  echo "✓ BUILD_CONFIG.json is valid"

# Verify BUILD_STATUS.md exists
test -f builds/{{CONFIG:build_name}}/BUILD_STATUS.md && \
  echo "✓ BUILD_STATUS.md exists"

# Verify SESSION.md exists
test -f builds/{{CONFIG:build_name}}/SESSION.md && \
  echo "✓ SESSION.md exists"

# Verify directory structure
if grep -q "Python" builds/{{CONFIG:build_name}}/BUILD_CONFIG.json; then
  test -d builds/{{CONFIG:build_name}}/src && \
  test -d builds/{{CONFIG:build_name}}/tests && \
  echo "✓ Python directory structure created"
elif grep -q "Swift" builds/{{CONFIG:build_name}}/BUILD_CONFIG.json; then
  test -d builds/{{CONFIG:build_name}}/Sources && \
  test -d builds/{{CONFIG:build_name}}/Tests && \
  echo "✓ Swift directory structure created"
fi
```

**Expected Output:**
```
✓ BUILD_CONFIG.json is valid
✓ BUILD_STATUS.md exists
✓ SESSION.md exists
✓ Python directory structure created (or Swift)
```

**Retry Policy:**
- Maximum 3 attempts
- If BUILD_CONFIG.json creation fails: Check write permissions, retry
- If directory creation fails: Check parent directory exists, retry
- If 3 failures: STOP and report error

## Notes

- Step 0 MUST always run first
- If BUILD_CONFIG.json exists, skip questions (enables zero-interaction rebuilds)
- Configuration is machine-updatable for CI/CD automation
- Each build is independent - can have multiple concurrent builds
- "Both" language option builds Python first, then Swift (ensures canonical artifacts exist)
